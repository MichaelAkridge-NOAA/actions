name: Publish Python Package to Posit Package Manager
author: Posit Package Manager Team
inputs:
  url:
    description: Package Manager URL
    required: true
  api-token:
    description: API token generated by Package Manager
    required: true
  python-version: 
    description: Python version to use
    default: '3.x'
  source:
    description: Package Manager Source to publish to
    required: true
  dir:
    description: Package source directory
    default: '.'
runs:
  using: composite
  steps:
    - name: Setup Python ${{ inputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.python-version }}

    - name: Build Python distributions
      run: |
        source_dir=$(mktemp -d)
        python3 -m pip install --upgrade build
        pip install --index-url https://packagemanager.posit.co/pypi/latest/simple twine
        (cd $source_dir; python3 -m build --outdir . $OLDPWD/${{ inputs.dir }})
        echo "DIST_DIR=$source_dir" >> $GITHUB_ENV
      shell: bash

    - name: Upload Python distributions
      if: github.ref == 'refs/heads/main'
      env:
        TWINE_REPOSITORY_URL: ${{ inputs.url }}/upload/pypi/${{ inputs.source }}
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ inputs.api-token }}
      run: "twine upload --verbose $DIST_DIR/*"
      shell: bash
